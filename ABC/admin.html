<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>老師題庫設定</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-2xl mx-auto bg-white rounded-xl p-6 shadow-md">
    <h1 class="text-2xl font-bold mb-4 text-blue-700">📘 老師題庫設定</h1>

    <form id="questionForm" class="space-y-4">
      <div>
        <label class="font-semibold">題庫 ID（週次）</label>
        <input type="text" id="questionId" class="w-full border p-2 rounded" required>
      </div>

      <!-- 五題輸入區 -->
      <div class="grid grid-cols-2 gap-4">
        <div><label>題目 1（中文）</label><input id="q1_zh" class="w-full border p-2 rounded" required></div>
        <div><label>題目 1（英文）</label><input id="q1_en" class="w-full border p-2 rounded" required></div>

        <div><label>題目 2（中文）</label><input id="q2_zh" class="w-full border p-2 rounded" required></div>
        <div><label>題目 2（英文）</label><input id="q2_en" class="w-full border p-2 rounded" required></div>

        <div><label>題目 3（中文）</label><input id="q3_zh" class="w-full border p-2 rounded" required></div>
        <div><label>題目 3（英文）</label><input id="q3_en" class="w-full border p-2 rounded" required></div>

        <div><label>題目 4（中文）</label><input id="q4_zh" class="w-full border p-2 rounded" required></div>
        <div><label>題目 4（英文）</label><input id="q4_en" class="w-full border p-2 rounded" required></div>

        <div><label>題目 5（中文）</label><input id="q5_zh" class="w-full border p-2 rounded" required></div>
        <div><label>題目 5（英文）</label><input id="q5_en" class="w-full border p-2 rounded" required></div>
      </div>

      <div>
        <label class="font-semibold">密碼驗證</label>
        <input type="password" id="adminPassword" class="w-full border p-2 rounded" required>
      </div>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">➕ 新增題庫</button>
    </form>

    <div id="msg" class="mt-4 text-green-600 font-bold"></div>

    <hr class="my-6 border-t">

    <!-- 未通過學生清單 -->
    <h2 class="text-lg font-bold mb-2">🚫 每週未通過學生</h2>
    <div id="unpassedList" class="space-y-4 text-red-700 bg-gray-50 p-4 rounded"></div>
  </div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbz42AHuGl7eIsyye0CjtjXXwjvP9WCzBrk637DC5Xg7F4hBSBZvYbG2xr_Fwf8SZCG1/exec";

    const form = document.getElementById("questionForm");
    const msg = document.getElementById("msg");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const pwd = document.getElementById("adminPassword").value;
      if (pwd !== "g4k27") {
        msg.textContent = "❌ 密碼錯誤，無法新增題庫";
        msg.classList.replace("text-green-600", "text-red-600");
        return;
      }

      const body = {
        action: "addQuestions",
        id: document.getElementById("questionId").value.trim(),
        q1_zh: document.getElementById("q1_zh").value.trim(),
        q1_en: document.getElementById("q1_en").value.trim(),
        q2_zh: document.getElementById("q2_zh").value.trim(),
        q2_en: document.getElementById("q2_en").value.trim(),
        q3_zh: document.getElementById("q3_zh").value.trim(),
        q3_en: document.getElementById("q3_en").value.trim(),
        q4_zh: document.getElementById("q4_zh").value.trim(),
        q4_en: document.getElementById("q4_en").value.trim(),
        q5_zh: document.getElementById("q5_zh").value.trim(),
        q5_en: document.getElementById("q5_en").value.trim(),
      };

      const res = await fetch(apiUrl, {
        method: "POST",
        body: JSON.stringify(body)
      });

      if (res.ok) {
        msg.textContent = "✅ 題庫已新增！";
        msg.classList.replace("text-red-600", "text-green-600");
        form.reset();
        loadUnpassed();
      } else {
        msg.textContent = "❌ 發生錯誤，請稍後再試";
        msg.classList.replace("text-green-600", "text-red-600");
      }
    });

    async function loadUnpassed() {
      const res = await fetch(apiUrl + "?action=getUnpassedStudents");
      const data = await res.json(); // [{id: "week1", unpassed: ["1", "3"]}]

      const container = document.getElementById("unpassedList");
      container.innerHTML = "";

      if (data.length === 0) {
        container.innerHTML = "<p>🎉 所有學生都已完成挑戰！</p>";
        return;
      }

      data.forEach(entry => {
        const div = document.createElement("div");
        div.innerHTML = `<strong>📘 題庫週次：${entry.id}</strong><br/>未通過學生：${entry.unpassed.join(", ")}`;
        container.appendChild(div);
      });
    }

    loadUnpassed();
  </script>
</body>
</html>
