<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>英語發音挑戰</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-xl mx-auto bg-white rounded-xl shadow-md p-6">
    <h1 class="text-2xl font-bold text-blue-700 mb-4">🎤 英語發音挑戰</h1>

    <!-- 開始區段 -->
    <div id="startSection">
      <label class="block font-semibold">座號：</label>
      <input type="text" id="studentId" class="w-full border p-2 rounded mb-4" placeholder="請輸入座號">

      <label class="block font-semibold">題庫週次：</label>
      <select id="questionSet" class="w-full border p-2 rounded mb-4"></select>

      <button onclick="startPractice()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">開始挑戰</button>
    </div>

    <!-- 題目區段 -->
    <div id="questionSection" class="hidden mt-4">
      <p class="font-semibold mb-2">請唸出以下英文：</p>
      <div class="p-4 border rounded bg-gray-50 mb-4">
        <div id="currentQuestionZH" class="text-lg font-semibold text-gray-700"></div>
        <div id="currentQuestionEN" class="text-xl text-blue-700 font-bold"></div>
      </div>
      <button onclick="startRecording()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">🎙️ 開始錄音</button>
      <div id="status" class="mt-2 text-sm text-gray-600"></div>
    </div>

    <!-- 完成區段 -->
    <div id="summarySection" class="hidden bg-white p-4 rounded shadow mt-4">
      <h2 class="text-xl font-bold mb-2">挑戰完成</h2>
      <ul id="summaryList" class="list-disc list-inside mb-4"></ul>
      <button onclick="restart()" class="bg-blue-500 text-white px-4 py-2 rounded">🔁 換人挑戰</button>
    </div>
  </div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbz42AHuGl7eIsyye0CjtjXXwjvP9WCzBrk637DC5Xg7F4hBSBZvYbG2xr_Fwf8SZCG1/exec";
let studentId = "";
let selectedId = "";
let questions = [];
let currentIndex = 0;
let results = [];

const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'en-US';
recognition.interimResults = false;
recognition.maxAlternatives = 1;

window.onload = async () => {
  const res = await fetch(apiUrl + "?action=getQuestionIds");
  const data = await res.json();
  const select = document.getElementById("questionSet");
  data.forEach(id => {
    const option = document.createElement("option");
    option.value = id;
    option.textContent = id;
    select.appendChild(option);
  });
};

async function startPractice() {
  studentId = document.getElementById("studentId").value.trim();
  selectedId = document.getElementById("questionSet").value;
  if (!studentId || !selectedId) return alert("請輸入座號並選擇題庫");

  const res = await fetch(`${apiUrl}?action=getQuestions&id=${selectedId}`);
  const data = await res.json();
  questions = [
    { zh: data.Q1_ZH, en: data.Q1_EN },
    { zh: data.Q2_ZH, en: data.Q2_EN },
    { zh: data.Q3_ZH, en: data.Q3_EN },
    { zh: data.Q4_ZH, en: data.Q4_EN },
    { zh: data.Q5_ZH, en: data.Q5_EN },
  ];
  currentIndex = 0;
  results = [];
  document.getElementById("startSection").classList.add("hidden");
  document.getElementById("questionSection").classList.remove("hidden");
  showQuestion();
}

function showQuestion() {
  const q = questions[currentIndex];
  document.getElementById("currentQuestionZH").textContent = q.zh;
  document.getElementById("currentQuestionEN").textContent = q.en;
  document.getElementById("status").textContent = `第 ${currentIndex + 1} 題，準備唸出來...`;
}

function startRecording() {
  document.getElementById("status").textContent = "錄音中，請開始唸出句子...";
  recognition.start();
  setTimeout(() => recognition.stop(), 5000);
}

recognition.onresult = (e) => {
  const text = e.results[0][0].transcript.toLowerCase().trim();
  const answer = questions[currentIndex].en.toLowerCase().trim();
  const correct = text === answer;
  results.push(correct ? "✅" : "❌");

  currentIndex++;
  if (currentIndex < questions.length) {
    showQuestion();
  } else {
    finish();
  }
};

function finish() {
  document.getElementById("questionSection").classList.add("hidden");
  document.getElementById("summarySection").classList.remove("hidden");

  const list = document.getElementById("summaryList");
  list.innerHTML = "";
  questions.forEach((q, i) => {
    const li = document.createElement("li");
    li.textContent = `${q.en}：${results[i]}`;
    list.appendChild(li);
  });

  const passed = results.every(r => r === "✅") ? "✅ 全部通過" : "❌ 未通過";

  fetch(apiUrl, {
    method: "POST",
    body: JSON.stringify({
      action: "recordSummary",
      studentId,
      questionId: selectedId,
      results,
      passed
    })
  });
}

function restart() {
  studentId = "";
  selectedId = "";
  questions = [];
  currentIndex = 0;
  results = [];

  document.getElementById("studentId").value = "";
  document.getElementById("startSection").classList.remove("hidden");
  document.getElementById("questionSection").classList.add("hidden");
  document.getElementById("summarySection").classList.add("hidden");
}
</script>
</body>
</html>
