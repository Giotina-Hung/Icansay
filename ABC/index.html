<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‹±èªç™¼éŸ³æŒ‘æˆ°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-image: linear-gradient(to right, #fceabb, #f8b500);
      font-family: 'Inter', sans-serif; /* ä½¿ç”¨ Inter å­—é«” */
    }
    /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body class="p-4 sm:p-6 flex items-center justify-center min-h-screen">
  <div class="w-full max-w-xl mx-auto bg-white rounded-3xl shadow-2xl p-6 border-4 border-yellow-300">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
      <h1 class="text-2xl sm:text-3xl font-bold text-pink-600 mb-2 sm:mb-0 text-center sm:text-left">ğŸŒŸ è‹±èªç™¼éŸ³æŒ‘æˆ° ğŸŒŸ</h1>
      <a href="admin.html" target="_blank" class="text-sm text-purple-600 underline hover:text-purple-800">ğŸ”’ è€å¸«è¨­å®š</a>
    </div>

    <div id="startSection">
      <label for="studentId" class="block font-bold mb-1">ğŸ§‘â€ğŸ“ åº§è™Ÿï¼š</label>
      <input type="text" id="studentId" class="w-full border-2 border-pink-300 p-2 rounded-lg mb-4 bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-pink-400" placeholder="è«‹è¼¸å…¥åº§è™Ÿ">

      <label for="questionSet" class="block font-bold mb-1">ğŸ“š é¡Œåº«é€±æ¬¡ï¼š</label>
      <select id="questionSet" class="w-full border-2 border-pink-300 p-2 rounded-lg mb-4 bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-pink-400"></select>

      <button id="startButton" class="bg-pink-500 text-white px-6 py-3 rounded-full hover:bg-pink-600 w-full font-bold text-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">ğŸš€ é–‹å§‹æŒ‘æˆ°</button>

      </div>

    <div id="questionSection" class="hidden mt-6">
      <p class="font-bold mb-2 text-lg">ğŸ¯ è«‹å”¸å‡ºä»¥ä¸‹è‹±æ–‡ï¼š</p>
      <div class="p-4 border-2 border-yellow-300 rounded-xl bg-yellow-100 mb-4 shadow-inner">
        <div id="currentQuestionZH" class="text-lg font-semibold text-gray-700 mb-1"></div>
        <div id="currentQuestionEN" class="text-2xl text-pink-700 font-extrabold"></div>
      </div>
      <button id="recordButton" onclick="startRecordingUserInitiated()" class="bg-green-500 text-white px-6 py-3 rounded-full hover:bg-green-600 font-bold text-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">ğŸ™ï¸ é–‹å§‹éŒ„éŸ³</button>
      <div id="status" class="mt-3 text-md text-purple-700 font-semibold"></div>
      <div class="flex justify-between mt-4">
        <button onclick="nextQuestion()" class="bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600 font-bold">ä¸‹ä¸€é¡Œ</button>
        <button onclick="endPractice()" class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 font-bold">çµæŸæŒ‘æˆ°</button>
      </div>
    </div>

    <div id="summarySection" class="hidden bg-white p-4 rounded-xl shadow mt-6 border-2 border-green-300">
      <h2 class="text-xl font-bold text-green-700 mb-2">ğŸ† æŒ‘æˆ°å®Œæˆ</h2>
      <ul id="summaryList" class="list-disc list-inside mb-4 text-lg text-gray-700"></ul>
      <button onclick="restart()" class="bg-blue-400 text-white px-6 py-3 rounded-full hover:bg-blue-500 font-bold text-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">ğŸ” æ›äººæŒ‘æˆ°</button>
    </div>

    <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-xl border-2 border-blue-400 text-center">
        <p id="messageText" class="text-lg font-semibold mb-4 text-gray-800"></p>
        <button onclick="hideMessageBox()" class="bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600 font-bold">ç¢ºå®š</button>
      </div>
    </div>

  </div>

<script>
// è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºä½ å¯¦éš›éƒ¨ç½²çš„ Google Apps Script URL
const apiUrl = "https://script.google.com/macros/s/AKfycbz42AHuGl7eIsyye0CjtjXXwjvP9WCzBrk637DC5Xg7F4hBSBZvYbG2xr_Fwf8SZCG1/exec";

let currentQuestionSetId = '';
let currentQuestions = [];
let currentQuestionIndex = 0;
let practiceResults = []; // å„²å­˜æ¯æ¬¡ç·´ç¿’çš„çµæœ

// SpeechRecognition ç›¸é—œè®Šæ•¸
let recognition;
let recognitionTimeout;
let isRecording = false;

// é¡¯ç¤ºè‡ªå®šç¾©è¨Šæ¯æ¡†
function showMessageBox(message) {
  document.getElementById('messageText').textContent = message;
  document.getElementById('messageBox').classList.remove('hidden');
}

// éš±è—è‡ªå®šç¾©è¨Šæ¯æ¡†
function hideMessageBox() {
  document.getElementById('messageBox').classList.add('hidden');
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
window.onload = async () => {
  try {
    // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ SpeechRecognition
    if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
      showMessageBox("âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ Google Chrome ç€è¦½å™¨ä»¥ç²å¾—æœ€ä½³é«”é©—ã€‚");
      document.getElementById('recordButton').disabled = true; // ç¦ç”¨éŒ„éŸ³æŒ‰éˆ•
    } else {
      // åˆå§‹åŒ– SpeechRecognition
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false; // åªç²å–å–®æ¬¡çµæœ
      recognition.interimResults = false; // ä¸é¡¯ç¤ºä¸­é–“çµæœ
      recognition.lang = 'en-US'; // è¨­å®šè¾¨è­˜èªè¨€ç‚ºè‹±æ–‡

      recognition.onstart = () => {
        isRecording = true;
        document.getElementById("status").textContent = "ğŸ™ï¸ éŒ„éŸ³ä¸­... è«‹å”¸å‡ºè‹±æ–‡ (5ç§’)";
        document.getElementById("recordButton").disabled = true; // éŒ„éŸ³æ™‚ç¦ç”¨æŒ‰éˆ•
      };

      recognition.onend = () => {
        isRecording = false;
        document.getElementById("recordButton").disabled = false; // éŒ„éŸ³çµæŸå¾Œå•Ÿç”¨æŒ‰éˆ•
        clearTimeout(recognitionTimeout); // æ¸…é™¤è¨ˆæ™‚å™¨
        // å¦‚æœæ²’æœ‰çµæœï¼Œè¡¨ç¤ºå¯èƒ½æ²’æœ‰è²éŸ³æˆ–è¾¨è­˜å¤±æ•—
        if (document.getElementById("status").textContent.includes("éŒ„éŸ³ä¸­")) {
            // å¦‚æœç‹€æ…‹ä»æ˜¯éŒ„éŸ³ä¸­ï¼Œè¡¨ç¤ºæ²’æœ‰è§¸ç™¼ onresult æˆ– onerror
            document.getElementById("status").textContent = "ğŸ—£ï¸ éŒ„éŸ³çµæŸï¼Œæ²’æœ‰åµæ¸¬åˆ°æœ‰æ•ˆè²éŸ³ã€‚";
            // ç”±æ–¼æ²’æœ‰è¾¨è­˜çµæœï¼Œé€™è£¡å¯ä»¥è¨­å®šç‚ºéŒ¯èª¤ï¼Œä¸¦è‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œ
            practiceResults.push("âŒ æ²’æœ‰è²éŸ³");
            setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
            }, 1500); // 1.5 ç§’å¾Œè‡ªå‹•è·³è½‰
        }
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const confidence = event.results[0][0].confidence;
        const expectedEnglish = currentQuestions[currentQuestionIndex].en;

        // é€™è£¡éœ€è¦å¯¦ä½œæ›´ç²¾ç¢ºçš„ç™¼éŸ³åˆ¤æ–·é‚è¼¯
        // ç›®å‰å…ˆç°¡å–®åˆ¤æ–·æ˜¯å¦åŒ…å«é—œéµå­—æˆ–æ¨¡æ“¬æ­£ç¢ºç‡
        let isCorrect = false;
        if (transcript.toLowerCase().includes(expectedEnglish.toLowerCase())) {
            isCorrect = true; // ç°¡å–®åˆ¤æ–·åŒ…å«é—œéµå­—
        } else {
            // æ¨¡æ“¬ç™¼éŸ³åˆ¤æ–·ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­éœ€è¦æ›´è¤‡é›œçš„æ¼”ç®—æ³•
            isCorrect = Math.random() > 0.5;
        }
        
        const resultText = isCorrect ? "âœ… æ­£ç¢º" : "âŒ éŒ¯èª¤";
        practiceResults.push(resultText); // è¨˜éŒ„çµæœ
        document.getElementById("status").textContent = `è¾¨è­˜çµæœ: "${transcript}" (${(confidence * 100).toFixed(2)}%) - ${resultText}`;

        // è‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œæˆ–çµæŸ
        setTimeout(() => {
          currentQuestionIndex++;
          displayQuestion();
        }, 1500); // 1.5 ç§’å¾Œè‡ªå‹•è·³è½‰
      };

      recognition.onerror = (event) => {
        isRecording = false;
        document.getElementById("recordButton").disabled = false;
        clearTimeout(recognitionTimeout);

        let errorMessage = "èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼š";
        if (event.error === 'no-speech') {
          errorMessage = "ğŸ—£ï¸ æ²’æœ‰åµæ¸¬åˆ°è²éŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
          practiceResults.push("âŒ æ²’æœ‰è²éŸ³"); // è¨˜éŒ„ç‚ºæ²’æœ‰è²éŸ³
        } else if (event.error === 'not-allowed') {
          errorMessage = "ğŸš« éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨éº¥å…‹é¢¨ã€‚";
          practiceResults.push("âŒ æ¬Šé™æ‹’çµ•");
        } else {
          errorMessage += event.error;
          practiceResults.push("âŒ è¾¨è­˜éŒ¯èª¤");
        }
        document.getElementById("status").textContent = errorMessage;
        showMessageBox(errorMessage); // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶

        // éŒ¯èª¤å¾Œä¹Ÿè‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œæˆ–çµæŸ
        setTimeout(() => {
            currentQuestionIndex++;
            displayQuestion();
        }, 2500); // 2.5 ç§’å¾Œè‡ªå‹•è·³è½‰
      };
    }

    // ç²å–é¡Œåº«é€±æ¬¡åˆ—è¡¨
    const res = await fetch(apiUrl + "?action=getQuestionIds");
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();
    const select = document.getElementById("questionSet");
    select.innerHTML = ''; // æ¸…ç©ºç¾æœ‰é¸é …
    if (data.length === 0) {
      const option = document.createElement("option");
      option.value = "";
      option.textContent = "ç„¡å¯ç”¨é¡Œåº«";
      select.appendChild(option);
    } else {
      data.forEach(id => {
        const option = document.createElement("option");
        option.value = id;
        option.textContent = id;
        select.appendChild(option);
      });
    }

    // å°‡äº‹ä»¶ç›£è½å™¨æ·»åŠ åˆ°ã€Œé–‹å§‹æŒ‘æˆ°ã€æŒ‰éˆ•
    document.getElementById('startButton').addEventListener('click', startPractice);

  } catch (err) {
    showMessageBox("âš ï¸ ç„¡æ³•é€£æ¥è³‡æ–™åº«æˆ–ç²å–åˆå§‹è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    console.error("åˆå§‹åŒ–éŒ¯èª¤:", err);
  }
};

// é–‹å§‹æŒ‘æˆ°
async function startPractice() {
  const studentId = document.getElementById("studentId").value.trim();
  currentQuestionSetId = document.getElementById("questionSet").value;

  if (!studentId) {
    showMessageBox("è«‹è¼¸å…¥åº§è™Ÿï¼");
    return;
  }
  if (!currentQuestionSetId) {
    showMessageBox("è«‹é¸æ“‡é¡Œåº«é€±æ¬¡ï¼");
    return;
  }

  try {
    // ç²å–é¸å®šé¡Œåº«çš„é¡Œç›®
    const res = await fetch(`${apiUrl}?action=getQuestions&id=${currentQuestionSetId}`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();

    if (Object.keys(data).length === 0) {
      showMessageBox("è©²é€±æ¬¡æ²’æœ‰æ‰¾åˆ°é¡Œç›®è³‡æ–™ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨ã€‚");
      return;
    }

    currentQuestions = [];
    for (let i = 1; i <= 5; i++) {
      if (data[`Q${i}_ZH`] && data[`Q${i}_EN`]) {
        currentQuestions.push({
          zh: data[`Q${i}_ZH`],
          en: data[`Q${i}_EN`]
        });
      }
    }

    if (currentQuestions.length === 0) {
      showMessageBox("è©²é€±æ¬¡æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é¡Œç›®å°æ‡‰ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨æ ¼å¼ã€‚");
      return;
    }

    currentQuestionIndex = 0;
    practiceResults = []; // é‡ç½®ç·´ç¿’çµæœ

    document.getElementById("startSection").classList.add("hidden");
    document.getElementById("questionSection").classList.remove("hidden");
    displayQuestion(); // é¡¯ç¤ºç¬¬ä¸€é“é¡Œç›®

  } catch (err) {
    showMessageBox("âš ï¸ ç„¡æ³•è¼‰å…¥é¡Œç›®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è³‡æ–™åº«è¨­å®šã€‚");
    console.error("è¼‰å…¥é¡Œç›®éŒ¯èª¤:", err);
  }
}

// é¡¯ç¤ºç•¶å‰é¡Œç›® (ä¸å†è‡ªå‹•å•Ÿå‹•éŒ„éŸ³)
function displayQuestion() {
  if (currentQuestionIndex < currentQuestions.length) {
    const question = currentQuestions[currentQuestionIndex];
    document.getElementById("currentQuestionZH").textContent = question.zh;
    document.getElementById("currentQuestionEN").textContent = question.en;
    document.getElementById("status").textContent = "è«‹é»æ“Šã€Œé–‹å§‹éŒ„éŸ³ã€æŒ‰éˆ•ã€‚";
    document.getElementById("recordButton").disabled = false; // ç¢ºä¿æŒ‰éˆ•å¯ç”¨
  } else {
    endPractice(); // æ‰€æœ‰é¡Œç›®éƒ½ç­”å®Œ
  }
}

// é–‹å§‹éŒ„éŸ³ (ç”±ç”¨æˆ¶é»æ“ŠæŒ‰éˆ•è§¸ç™¼)
function startRecordingUserInitiated() {
  // å¦‚æœå·²ç¶“åœ¨éŒ„éŸ³ä¸­ï¼Œå…ˆåœæ­¢
  if (isRecording) {
    recognition.stop();
    clearTimeout(recognitionTimeout); // æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
    isRecording = false; // é‡ç½®ç‹€æ…‹
  }

  if (recognition) {
    try {
      recognition.start();
      // è¨­å®š 5 ç§’å¾Œè‡ªå‹•åœæ­¢éŒ„éŸ³
      recognitionTimeout = setTimeout(() => {
        if (isRecording) { // ç¢ºä¿ä»åœ¨éŒ„éŸ³ä¸­æ‰åœæ­¢
            recognition.stop();
        }
      }, 5000); // 5000 æ¯«ç§’ = 5 ç§’
    } catch (e) {
      // æ•ç² 'recognition has already started' éŒ¯èª¤ï¼Œä¸¦å¿½ç•¥
      if (e.name === 'InvalidStateError' && e.message.includes('recognition has already started')) {
        console.warn("èªéŸ³è¾¨è­˜å™¨å·²åœ¨é‹è¡Œï¼Œç„¡éœ€é‡è¤‡å•Ÿå‹•ã€‚");
        // ä¸é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶ï¼Œå› ç‚ºé€™ä¸æ˜¯ä¸€å€‹çœŸæ­£çš„éŒ¯èª¤ï¼Œè€Œæ˜¯é‚è¼¯ä¸Šçš„é‡è¤‡å•Ÿå‹•
      } else if (e.name === 'AbortError') {
        document.getElementById("status").textContent = "éŒ„éŸ³å·²åœæ­¢ã€‚";
      } else {
        document.getElementById("status").textContent = `éŒ„éŸ³å•Ÿå‹•å¤±æ•—: ${e.message}`;
        console.error("éŒ„éŸ³å•Ÿå‹•éŒ¯èª¤:", e);
        showMessageBox(`éŒ„éŸ³å•Ÿå‹•å¤±æ•—: ${e.message}`);
      }
      isRecording = false;
      document.getElementById("recordButton").disabled = false;
    }
  } else {
    showMessageBox("èªéŸ³è¾¨è­˜åŠŸèƒ½æœªåˆå§‹åŒ–æˆ–ä¸æ”¯æ´ã€‚");
  }
}

// æ‰‹å‹•è·³åˆ°ä¸‹ä¸€é¡Œ (å¦‚æœéœ€è¦ï¼Œä½†è‡ªå‹•è·³è½‰æ›´æµæš¢)
function nextQuestion() {
  if (isRecording) {
      recognition.stop(); // åœæ­¢ç•¶å‰éŒ„éŸ³
  }
  currentQuestionIndex++;
  displayQuestion();
}

// çµæŸæŒ‘æˆ°ä¸¦é¡¯ç¤ºç¸½çµ
async function endPractice() {
  document.getElementById("questionSection").classList.add("hidden");
  document.getElementById("summarySection").classList.remove("hidden");

  const summaryList = document.getElementById("summaryList");
  summaryList.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨

  let allPassed = true;
  for (let i = 0; i < currentQuestions.length; i++) {
    const li = document.createElement("li");
    // ç¢ºä¿ practiceResults æœ‰å°æ‡‰çš„çµæœï¼Œå¦å‰‡é¡¯ç¤ºæœªä½œç­”
    const result = practiceResults[i] !== undefined ? practiceResults[i] : "æœªä½œç­”"; 
    li.innerHTML = `<strong>${currentQuestions[i].en}</strong>: ${result}`;
    summaryList.appendChild(li);
    if (result.includes("âŒ")) {
      allPassed = false;
    }
  }

  const finalStatus = allPassed ? "âœ… å…¨éƒ¨é€šé" : "âŒ æœªé€šé";
  const liFinal = document.createElement("li");
  liFinal.innerHTML = `<strong class="text-green-700">ç¸½çµï¼š${finalStatus}</strong>`;
  summaryList.appendChild(liFinal);

  // å°‡çµæœè¨˜éŒ„åˆ° Google è©¦ç®—è¡¨
  try {
    const studentId = document.getElementById("studentId").value.trim();
    const payload = {
      action: "recordSummary",
      studentId: studentId,
      questionId: currentQuestionSetId,
      results: practiceResults,
      passed: finalStatus
    };

    const res = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
        const errorText = await res.text();
        throw new Error(`HTTP error! status: ${res.status}, response: ${errorText}`);
    }
    const textResponse = await res.text();
    console.log("è¨˜éŒ„æ‘˜è¦å›æ‡‰:", textResponse);
    showMessageBox("æŒ‘æˆ°çµæœå·²è¨˜éŒ„ï¼");

  } catch (err) {
    showMessageBox("âš ï¸ ç„¡æ³•è¨˜éŒ„æŒ‘æˆ°çµæœã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ– Apps Script è¨­å®šã€‚");
    console.error("è¨˜éŒ„çµæœéŒ¯èª¤:", err);
  }
}

// é‡æ–°é–‹å§‹
function restart() {
  document.getElementById("studentId").value = ""; // æ¸…ç©ºåº§è™Ÿ
  document.getElementById("summarySection").classList.add("hidden");
  document.getElementById("startSection").classList.remove("hidden");
  document.getElementById("status").textContent = ""; // æ¸…ç©ºç‹€æ…‹
}
</script>
</body>
</html>
